function initAudioNodes(a,b){if(audioNodes=new AudioNodes(a,["delay","tunachorus","tunawahwah","tunaoverdrive","tunatremolo","streamDestination"]),audioNodes.loadSet(audioNodes.settings.clearSound),b){var c=a.getVideoTracks();audioNodes.stream.addTrack(c[0])}return audioNodes.stream}function AudioNodes(a,b){this.setSettings(),this.createNodes(a,b),this.stream=this.nodes[this.nodes.length-1].node.stream}function sendMessage(a){socket.emit("message",a)}function handleUserMedia(a){var a=initAudioNodes(a,!0);localVideo.src=window.URL.createObjectURL(a),localStream=a,sendMessage("got user media"),isInitiator&&maybeStart()}function handleUserMediaError(){}function maybeStart(){!isStarted&&"undefined"!=typeof localStream&&isChannelReady&&(createPeerConnection(),pc.addStream(localStream),isStarted=!0,isInitiator&&doCall())}function createPeerConnection(){try{pc=new RTCPeerConnection(null),pc.onicecandidate=handleIceCandidate,pc.onaddstream=handleRemoteStreamAdded,pc.onremovestream=handleRemoteStreamRemoved}catch(a){return void alert("Cannot create RTCPeerConnection object.")}}function handleIceCandidate(a){a.candidate&&sendMessage({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate})}function handleRemoteStreamAdded(a){remoteVideo.src=window.URL.createObjectURL(a.stream),remoteStream=a.stream}function handleCreateOfferError(){}function doCall(){pc.createOffer(setLocalAndSendMessage,handleCreateOfferError)}function doAnswer(){pc.createAnswer(setLocalAndSendMessage,null,sdpConstraints)}function setLocalAndSendMessage(a){a.sdp=preferOpus(a.sdp),pc.setLocalDescription(a),sendMessage(a)}function requestTurn(a){var b=!1;for(var c in pc_config.iceServers)if("turn:"===pc_config.iceServers[c].url.substr(0,5)){b=!0,turnReady=!0;break}if(!b){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState&&200===d.status){var a=JSON.parse(d.responseText);pc_config.iceServers.push({url:"turn:"+a.username+"@"+a.turn,credential:a.password}),turnReady=!0}},d.open("GET",a,!0),d.send()}}function handleRemoteStreamAdded(a){remoteVideo.src=window.URL.createObjectURL(a.stream),remoteStream=a.stream}function handleRemoteStreamRemoved(){}function hangup(){stop(),sendMessage("bye")}function handleRemoteHangup(){}function stop(){isStarted=!1,pc.close(),pc=null}function preferOpus(a){for(var b,c=a.split("\r\n"),d=0;d<c.length;d++)if(-1!==c[d].search("m=audio")){b=d;break}if(null===b)return a;for(d=0;d<c.length;d++)if(-1!==c[d].search("opus/48000")){var e=extractSdp(c[d],/:(\d+) opus\/48000/i);e&&(c[b]=setDefaultCodec(c[b],e));break}return c=removeCN(c,b),a=c.join("\r\n")}function extractSdp(a,b){var c=a.match(b);return c&&2===c.length?c[1]:null}function setDefaultCodec(a,b){for(var c=a.split(" "),d=[],e=0,f=0;f<c.length;f++)3===e&&(d[e++]=b),c[f]!==b&&(d[e++]=c[f]);return d.join(" ")}function removeCN(a,b){for(var c=a[b].split(" "),d=a.length-1;d>=0;d--){var e=extractSdp(a[d],/a=rtpmap:(\d+) CN\/\d+/i);if(e){var f=c.indexOf(e);-1!==f&&c.splice(f,1),a.splice(d,1)}}return a[b]=c.join(" "),a}if(appSupported=!0,window.webkitAudioContext||navigator.webkitGetUserMedia||(appSupported=!1,$(".modal").modal()),$(document).ready(function(){function a(){b.css("background-position",c+"px 0px"),c+=5}$(".effects-show").click(function(){$(".effects-panel").show()}),$(".effects-hide").click(function(){$(".effects-panel").hide()}),$(".option-clear").click(function(){$(this).hasClass("active")||($(".btn-option").removeClass("active"),$(this).addClass("active"),audioNodes.selectOption("clear"))}),$(".option-custom").click(function(){$(this).hasClass("active")||($(".btn-option").removeClass("active"),$(this).addClass("active"),audioNodes.selectOption("custom"))}),$(".option1").click(function(){$(this).hasClass("active")||($(".btn-option").removeClass("active"),$(this).addClass("active"),audioNodes.selectOption("option1"))}),$(".option2").click(function(){$(this).hasClass("active")||($(".btn-option").removeClass("active"),$(this).addClass("active"),audioNodes.selectOption("option2"))}),$(".option3").click(function(){$(this).hasClass("active")||($(".btn-option").removeClass("active"),$(this).addClass("active"),audioNodes.selectOption("option3"))});var b=$(".block--animate"),c=0;"null"!=typeof b&&window.setInterval(a,40);var d="<button type='button' class='close' aria-hidden='true'>&times;</button><h3>About</h3><p>This is an experimental app built with node.js, express.js, sockets.io, WebRTC, Web Audio Api, and tuna.js library. </p><p>It allows you to modify your voice with special effects and invite someone to have a video chat directly in your browser. So far it only works in Google Chrome. </p><p><a href=https://github.com/miselaytes-anton'>GitHub</a></p><h3>Contact</h3><p><a href='http://amiselaytes.com'>amiselaytes.com</a>, a.miselaytes@gmail.com</p>";$(".about-popover").popover({content:d,html:!0,placement:"top"}),$(".about-popover").click(function(){$(".close").click(function(){$(".about-popover").popover("hide"),console.log("close")})})}),AudioNodes.prototype.setSettings=function(){this.settings={},this.settings.defaultSet={input:{isConnected:!0},delay:{isConnected:!0,delayTime:0},tunachorus:{isConnected:!0,rate:8,feedback:.85,delay:45e-5,bypass:!1},tunawahwah:{isConnected:!0,automode:!0,baseFrequency:.5,excursionOctaves:2,sweep:1,resonance:10,sensitivity:.5,bypass:!1},tunaoverdrive:{isConnected:!0,outputGain:.5,drive:.7,curveAmount:1,algorithmIndex:5,bypass:0},tunaphaser:{isConnected:!0,rate:8,depth:.3,feedback:.5,stereoPhase:100,baseModulationFrequency:700,bypass:0},tunatremolo:{isConnected:!0,intensity:1,rate:8,stereoPhase:180,bypass:!1},gain:{isConnected:!0,gain:.5},compressor:{isConnected:!0},destination:{isConnected:!0},streamDestination:{isConnected:!0}},this.settings.clearSound={delay:{isConnected:!1},tunachorus:{isConnected:!1},tunawahwah:{isConnected:!1},tunaoverdrive:{isConnected:!1},tunaphaser:{isConnected:!1},tunatremolo:{isConnected:!1},gain:{gain:{value:.5}}},this.settings.underWater={delay:{isConnected:!0,delayTime:{value:.5}},tunachorus:{isConnected:!0,feedback:.85},tunawahwah:{isConnected:!0,baseFrequency:0,excursionOctaves:1,resonance:100,sensitivity:.5},tunaoverdrive:{isConnected:!1},tunatremolo:{isConnected:!1},gain:{isConnected:!0,gain:{value:.9}}},this.settings.spaceSignal={delay:{isConnected:!0,delayTime:{value:0}},tunachorus:{isConnected:!0,feedback:.85,delay:.004},tunawahwah:{isConnected:!0,baseFrequency:.8,excursionOctaves:3,resonance:10,sensitivity:.8},tunaoverdrive:{isConnected:!1},tunatremolo:{isConnected:!1},gain:{isConnected:!0,gain:{value:.5}}},this.settings.brokenRadio={delay:{isConnected:!1},tunachorus:{isConnected:!1},tunawahwah:{isConnected:!1},tunaoverdrive:{isConnected:!0,drive:.7,algorithmIndex:1},tunatremolo:{isConnected:!0,intensity:.2,rate:8,stereoPhase:8,bypass:!1},gain:{isConnected:!0,gain:{value:.3}},compressor:{isConnected:!0},destination:{isConnected:!0},streamDestination:{isConnected:!0}},this.properties={};for(var a in this.settings.defaultSet)if(this.settings.defaultSet.hasOwnProperty(a)){this.properties[a]=[];for(var b in this.settings.defaultSet[a])this.settings.defaultSet[a].hasOwnProperty(b)&&this.properties[a].push(b)}},AudioNodes.prototype.createNodes=function(a,b,c){this.nodes=b||[];for(var d=0;d<this.nodes.length;d++)if(/tuna/.test(this.nodes[d])){tuna=new Tuna(context);break}this.nodes.unshift("input"),this.nodes.push("gain","compressor","destination");var e=this.nodes.indexOf("streamDestination");e>-1&&(this.nodes.splice(e,1),this.nodes.push("streamDestination"));for(var c=this.settings.defaultSet,d=0;d<this.nodes.length;d++){var f=this.nodes[d],g=c[f];switch(this.nodes[d]={name:f},f){case"input":var h=context.createMediaStreamSource(a);break;case"delay":var h=context.createDelay(5);h.delayTime.value=c.delay.delayTime||0;break;case"gain":var h=context.createGain();h.gain.value=g.gain;break;case"tunachorus":var h=new tuna.Chorus(g);break;case"tunawahwah":var h=new tuna.WahWah(g);break;case"tunaphaser":var h=new tuna.Phaser(g);break;case"tunaoverdrive":var h=new tuna.Overdrive(g);break;case"tunatremolo":var h=new tuna.Tremolo(g);break;case"compressor":var h=context.createDynamicsCompressor();break;case"streamDestination":var h=context.createMediaStreamDestination();break;case"destination":var h=context.destination;break;default:return void console.error(this.nodes[d]+" is not an allowed node type")}h.isConnected=g.isConnected,"object"==typeof h&&(this.nodes[d].node=h),d>0&&("streamDestination"==this.nodes[d].name?this.nodes[d-2].node.connect(this.nodes[d].node):this.nodes[d-1].node.connect(this.nodes[d].node.input||this.nodes[d].node))}this.attachEvents(this.nodes)},AudioNodes.prototype.attachEvents=function(a){for(var b=this,c=0;c<a.length;c++){var d=this.properties[a[c].name],e="."+a[c].name+"-switch",f="";for(var g in d)d.hasOwnProperty(g)&&"isConnected"!=d[g]&&(f+="."+a[c].name+"-"+d[g]+", ");switch(f=f.substring(0,f.length-2),a[c].name){case"delay":var h=a[c];$(e).change(h,function(){b.nodeSwitch(h)}),$(f).change(h,function(){b.nodeChangeValue(h,this)});break;case"gain":var i=a[c];$(f).change(i,function(){b.nodeChangeValue(i,this)});break;case"tunachorus":var j=a[c];$(e).change(j,function(){b.nodeSwitch(j)}),$(f).change(j,function(){b.nodeChangeValue(j,this)});break;case"tunawahwah":var k=a[c];$(e).change(k,function(){b.nodeSwitch(k)}),$(f).change(k,function(){b.nodeChangeValue(k,this)});break;case"tunaoverdrive":var l=a[c];$(e).change(l,function(){b.nodeSwitch(l)}),$(f).change(l,function(){b.nodeChangeValue(l,this)});break;case"tunaphaser":var m=a[c];$(e).change(m,function(){b.nodeSwitch(m)});break;case"tunatremolo":var n=a[c];$(e).change(n,function(){b.nodeSwitch(n)})}}},AudioNodes.prototype.resetInputs=function(){var a=this.settings.defaultSet;for(var b in a)if(a.hasOwnProperty(b)){var c=a[b],d="."+b+"-switch";null!=document.querySelector(d)&&(document.querySelector(d).checked=c.isConnected);for(var e in c){var f="."+b+"-"+e;c.hasOwnProperty(e)&&null!=document.querySelector(f)&&(document.querySelector(f).value=c[e])}}},AudioNodes.prototype.nodeSwitch=function(a){for(var b=this.nodes.indexOf(a),c=1;c<this.nodes.length;c++)if(this.nodes[b-c].node.isConnected){var d=this.nodes[b-c].node||null;break}for(var c=1;c<this.nodes.length;c++)if(this.nodes[b+c].node.isConnected){var e=this.nodes[b+c].node||null;break}a.node.isConnected?(d.disconnect(0),a.node.disconnect(0),d.connect(e.input||e)):(d.disconnect(0),d.connect(a.node.input||a.node),a.node.connect(e.input||e)),a.node.isConnected=!a.node.isConnected},AudioNodes.prototype.nodeChangeValue=function(a,b){var c=parseFloat(b.value),d=a.node;if(d instanceof GainNode&&(d.gain.value=c),d instanceof DelayNode&&(d.delayTime.value=c),d instanceof Tuna.prototype.Chorus||d instanceof Tuna.prototype.WahWah||d instanceof Tuna.prototype.Overdrive||d instanceof Tuna.prototype.Phaser){var e=b.name;"undefined"!=d[e]?d[e]=c:console.error($(b).attr("name")+" is not an allowed setting name for this tuna node")}},AudioNodes.prototype.saveCustomSet=function(){var a=this.nodes;this.settings.customSet={};for(var b=0;b<a.length;b++){var c=a[b].name,d=a[b].node;this.settings.customSet[c]={};var e=this.settings.customSet[c];if("undefined"!=this.properties[c])var f=this.properties[c]||[];for(var g=0;g<f.length;g++){var h=f[g];if("object"==typeof d[h]){e[h]={};for(var i in d[h])d[h].hasOwnProperty(i)&&(e[h][i]=d[h][i])}else e[h]=d[h]}}},AudioNodes.prototype.selectOption=function(a){switch(a){case"clear":this.loadSet(this.settings.clearSound);break;case"option1":this.loadSet(this.settings.underWater);break;case"option2":this.loadSet(this.settings.spaceSignal);break;case"option3":this.loadSet(this.settings.brokenRadio);break;case"custom":this.resetInputs(),this.loadSet(this.settings.defaultSet);break;default:console.error("unknown option's name")}},AudioNodes.prototype.loadSet=function(a){for(var b=0;b<this.nodes.length;b++){var c=this.nodes[b],d=this.nodes[b].name,e=a[d];if("undefined"!=typeof e){e.isConnected!=c.node.isConnected&&"undefined"!=typeof e.isConnected&&this.nodeSwitch(c);for(var f in e)if(e.hasOwnProperty(f))if("object"==typeof e[f])for(var g in e[f])e[f].hasOwnProperty(g)&&"undefined"!=e[f][g]&&(c.node[f][g]=e[f][g]);else"undefined"!=e[f]&&(c.node[f]=e[f])}}},appSupported){var isChannelReady,isInitiator=!1,isStarted=!1,localStream,pc,remoteStream,turnReady,pc_config={iceServers:[{url:"stun:stun.l.google.com:19302"}]},pc_constraints={optional:[{DtlsSrtpKeyAgreement:!0}]},sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},socket=io.connect();"undefined"!=typeof room&&socket.emit("create or join",room),socket.on("created",function(){isInitiator=!0}),socket.on("full",function(){}),socket.on("join",function(){isChannelReady=!0}),socket.on("joined",function(){isChannelReady=!0}),socket.on("log",function(){}),socket.on("message",function(a){if("got user media"===a)maybeStart();else if("offer"===a.type)isInitiator||isStarted||maybeStart(),pc.setRemoteDescription(new RTCSessionDescription(a)),doAnswer();else if("answer"===a.type&&isStarted)pc.setRemoteDescription(new RTCSessionDescription(a));else if("candidate"===a.type&&isStarted){var b=new RTCIceCandidate({sdpMLineIndex:a.label,candidate:a.candidate});pc.addIceCandidate(b)}else"bye"===a&&isStarted&&handleRemoteHangup()});var localVideo=document.querySelector("#localVideo"),remoteVideo=document.querySelector("#remoteVideo"),constraints={video:!0,audio:!0};/room/.test(window.location.pathname)&&getUserMedia(constraints,handleUserMedia,handleUserMediaError),"localhost"!=location.hostname&&requestTurn("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913"),window.onbeforeunload=function(){sendMessage("bye")}}